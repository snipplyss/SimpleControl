local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()

local HttpService = game:GetService("HttpService")
local SCRIPT_ID = "437c441890edb02afcdeb220d16d75c4"
local PROJECT_ID = "695a47a22ff5d0ea927f73f996e71128"
local DISCORD_INVITE = "https://discord.gg/prtdk55WKm"
local API_URL = "https://sdkapi-public.luarmor.net/library.lua"
local PROTECTED_LOADER_URL = "https://api.luarmor.net/files/v4/loaders/437c441890edb02afcdeb220d16d75c4.lua"
local KEY_FILE = "SimpleControlHub/luarmor_key.txt"

local apiCache = nil
local keyInputValue = ""
local saveKeyEnabled = true

local function notify(title, content, duration)
    WindUI:Notify({
        Title = title,
        Content = content,
        Duration = duration or 4,
    })
end

local function ensureFolder()
    if makefolder and not isfolder("SimpleControlHub") then
        pcall(function()
            makefolder("SimpleControlHub")
        end)
    end
end

local function saveKey(key)
    if not writefile then
        return
    end

    ensureFolder()
    pcall(function()
        writefile(KEY_FILE, key)
    end)
end

local function loadSavedKey()
    if not (readfile and isfile and isfile(KEY_FILE)) then
        return ""
    end

    local ok, data = pcall(function()
        return readfile(KEY_FILE)
    end)

    if not ok or type(data) ~= "string" then
        return ""
    end

    return data:gsub("%s+", "")
end

local function ensureApi()
    if apiCache then
        return apiCache
    end

    local ok, api = pcall(function()
        local source = game.HttpGetAsync and game:HttpGetAsync(API_URL) or game:HttpGet(API_URL)
        return loadstring(source)()
    end)

    if not ok or type(api) ~= "table" then
        return nil, "Failed to initialize Luarmor API"
    end

    api.script_id = SCRIPT_ID
    apiCache = api
    return apiCache
end

local function formatRemaining(data)
    if type(data) ~= "table" then
        return "Unknown"
    end

    local authExpire = tonumber(data.auth_expire)
    if not authExpire or authExpire <= 0 then
        return "Lifetime"
    end

    local seconds = math.max(0, authExpire - os.time())
    return tostring(seconds) .. "s"
end

local function checkKey(key)
    local keyText = tostring(key or ""):gsub("%s+", "")
    if keyText == "" then
        return false, "KEY_INVALID", "Key is empty", nil
    end

    local api, apiErr = ensureApi()
    if not api then
        return false, "UNKNOWN_ERROR", apiErr or "API init failed", nil
    end

    local ok, status = pcall(function()
        return api.check_key(keyText)
    end)

    if not ok or type(status) ~= "table" then
        return false, "UNKNOWN_ERROR", "Unable to check key", nil
    end

    local code = tostring(status.code or "UNKNOWN_ERROR")
    local message = tostring(status.message or code)

    if code == "KEY_VALID" then
        return true, code, message, status
    end

    return false, code, message, status
end

local window = WindUI:CreateWindow({
    Title = "Snipplyss Luarmor Loader",
    Icon = "shield",
    Folder = "SimpleControlHubLoader",
    Size = UDim2.fromOffset(420, 340),
    Transparent = true,
    Theme = "Dark",
})

local authTab = window:Tab({
    Title = "Auth",
    Icon = "key",
})

authTab:Paragraph({
    Title = "Project",
    Desc = "Project: " .. PROJECT_ID,
})

authTab:Input({
    Title = "Luarmor Key",
    Placeholder = "Paste your 32-char key",
    Value = "",
    Callback = function(value)
        keyInputValue = tostring(value or "")
    end,
})

authTab:Toggle({
    Title = "Save Key",
    Value = true,
    Callback = function(state)
        saveKeyEnabled = state == true
    end,
})

authTab:Button({
    Title = "Use Saved Key",
    Callback = function()
        local saved = loadSavedKey()
        if saved == "" then
            notify("Luarmor", "No saved key found.", 3)
            return
        end

        keyInputValue = saved
        notify("Luarmor", "Saved key loaded.", 2)
    end,
})

authTab:Button({
    Title = "Join Discord",
    Callback = function()
        if type(setclipboard) == "function" then
            setclipboard(DISCORD_INVITE)
        end
        notify("Discord", "Invite copied to clipboard.", 3)
    end,
})

authTab:Button({
    Title = "Validate + Load Script",
    Callback = function()
        local keyText = tostring(keyInputValue or ""):gsub("%s+", "")
        if keyText == "" then
            keyText = loadSavedKey()
        end

        local ok, code, message, status = checkKey(keyText)
        if not ok then
            notify("Auth Error", code .. " - " .. message, 5)
            return
        end

        local data = status and status.data or nil
        local remaining = formatRemaining(data)
        local executions = data and data.total_executions or "?"

        notify("Auth Success", "Remaining: " .. remaining .. " | Exec: " .. tostring(executions), 4)

        if saveKeyEnabled then
            saveKey(keyText)
        end

        getgenv().script_key = keyText

        local loaded, loadErr = pcall(function()
            local source = game.HttpGetAsync and game:HttpGetAsync(PROTECTED_LOADER_URL) or game:HttpGet(PROTECTED_LOADER_URL)
            loadstring(source)()
        end)

        if not loaded then
            notify("Load Error", tostring(loadErr), 5)
        end
    end,
})

local autoKey = loadSavedKey()
if autoKey ~= "" then
    keyInputValue = autoKey
    notify("Luarmor", "Saved key detected. Press Validate + Load Script.", 4)
end
